<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Bunny</title>
    <link rel="stylesheet" href="style.css">
    <script type="text/javascript" src="paper-full.js"></script>
	<script type="text/javascript">
	paper.install(window);
	var leftEar, leftEarRot = 0, leftEarPivot, rightEar, rightEarRot = 0, rightEarPivot, 
		leftHand, leftHandRot = 0, leftHandPivot, rightHand, rightHandRot = 0, rightHandPivot, 
		leftLeg, leftLegRot = 0, leftLegPivot, rightLeg, rightLegRot = 0, rightLegPivot,
		leftPupil, rightPupil, mouthOpen, wholeBody, isSpeaking = 0, avarageVolume = 0, isLive = 0, passer = [0,0,0,0], centra = 0;
	function onLoadForSVG() {
		//var canvas = document.getElementById('canvas');
		// Create an empty project and a view for the canvas:
		paper.setup('canvas');
		project.clear();
		project.importSVG("j2nes.svg", function(item) {
			// Fit the circlePath to the bounding rectangle of
			// the rectangular path:
			wholeBody = item;
			project = view.center;
			item.fitBounds(view.bounds);
			setupSVG();
			view.draw();
			view.onFrame = function(event) {
				react(event);
				view.draw();
			}
			function onResize(event) {
				// Whenever the window is resized, recenter the path:
				console.log("hello");
				//project.position = view.center;
				item.fitBounds(view.bounds);
			}
			window.addEventListener('resize', onResize);
		});
		
		/*var file = document.getElementById('file');
		file.addEventListener('change', function (event) {
		
			var files = event.target.files;
			for (var i = 0; i < files.length; i++) {
				var file = files[i];
				if (file.type.match('svg')) {
					project.clear();
					project.importSVG(file, function(item) {
						// Fit the circlePath to the bounding rectangle of
						// the rectangular path:
						wholeBody = item;
						project = view.center;
						item.fitBounds(view.bounds);
						setupSVG();
						view.draw();
						view.onFrame = function(event) {
							react(event);
							view.draw();
						}
						function onResize(event) {
							// Whenever the window is resized, recenter the path:
							console.log("hello");
							//project.position = view.center;
							item.fitBounds(view.bounds);
						}
						window.addEventListener('resize', onResize);
					});
				}
			}
		});*/
	}
	function setupSVG(){
		leftEar = project.getItem( { name: "left-ear" });
		if(project.getItem( { name: "pivot-left-ear" }))
			leftEarPivot = project.getItem( { name: "pivot-left-ear" }).position;
		rightEar = project.getItem( { name: "right-ear" });
		if(project.getItem( { name: "pivot-right-ear" }))
			rightEarPivot = project.getItem( { name: "pivot-right-ear" }).position;
		leftHand = project.getItem( { name: "left-hand" });
		if(project.getItem( { name: "pivot-left-hand" }))
			leftHandPivot = project.getItem( { name: "pivot-left-hand" }).position;
		rightHand = project.getItem( { name: "right-hand" });
		if(project.getItem( { name: "pivot-right-hand" }))
			rightHandPivot = project.getItem( { name: "pivot-right-hand" }).position;
		leftLeg = project.getItem( { name: "left-leg" });
		if(project.getItem( { name: "pivot-left-leg" }))
			leftLegPivot = project.getItem( { name: "pivot-left-leg" }).position;
		rightLeg = project.getItem( { name: "right-leg" });
		if(project.getItem( { name: "pivot-right-leg" }))
			rightLegPivot = project.getItem( { name: "pivot-right-leg" }).position;
		leftPupil = project.getItem( { name: "left-pupil" });
		rightPupil = project.getItem( { name: "right-pupil" });
		mouthOpen = project.getItem( { name: "mouth-open" });
	}
	// t: current time, b: begInnIng value, c: change In value, d: duration
	function easeOutBack(t, b, c, d, s){
		if (s == undefined) 
			s = 1.70158; 
		return c*((t=t/d-1)*t*((s+1)*t + s) + 1) + b; 
	}
	function easeInOutQuart(t, b, c, d) { 
 		if ((t/=d/2) < 1) return c/2*t*t*t*t + b; 
 		return -c/2 * ((t-=2)*t*t*t - 2) + b; 
	}
	function easeOutBounce (t, b, c, d) { 
		if ((t/=d) < (1/2.75)) { 
 		return c*(7.5625*t*t) + b; 
		} else if (t < (2/2.75)) { 
			return c*(7.5625*(t-=(1.5/2.75))*t + .75) + b; 
		} else if (t < (2.5/2.75)) { 
			return c*(7.5625*(t-=(2.25/2.75))*t + .9375) + b; 
		} else { 
			return c*(7.5625*(t-=(2.625/2.75))*t + .984375) + b; 
		} 
	};

	var step = 3, enlarged = 0, lastAngle = 0, notFocused = true, notAlready = true;
	var timer1 = 0, timer2 = 0, timer3 = 0, timer4 = 0;
	function react(event){
		//leftEar.fillColor = new Color(Math.random(), Math.random(), Math.random());
		if(isLive){
			leftEarRot =- (avarageVolume * 70  - 41);
		}else{
			leftEarRot =- (avarageVolume * 250  - 41);
		}
		step = leftEarRot - lastAngle;
		lastAngle = leftEarRot;
		
		//if(leftEarRot >= -21 && leftEarRot <= 21){
		leftEar.rotate(step, leftEarPivot);
		rightEar.rotate(-step, rightEarPivot);
		//leftHand.rotate(step, leftHandPivot);
		//rightHand.rotate(step, rightHandPivot);
		
		//Left handed hello
		if(passer[0] == 1){
			timer1++;
			if(timer1 < 15){
				var val= easeOutBounce(timer1, 0, 5, 15);
				leftHand.rotate(-val, leftHandPivot);
			}else if(timer1 < 30){
				var val= easeOutBounce(timer1-15, 0, 5, 15);
				leftHand.rotate(val, leftHandPivot);
			}
			if(timer1 >= 30){
				passer[0] = 0; timer1 = 0;
			}
		}
		//Right handed hello
		if(passer[1] == 1){
			timer2++;
			if(timer2 < 15){
				var val= easeOutBounce(timer2, 0, 5, 15);
				rightHand.rotate(val, rightHandPivot);
			}else if(timer2 < 30){
				var val= easeOutBounce(timer2-15, 0, 5, 15);
				rightHand.rotate(-val, rightHandPivot);
			}
			
			if(timer2 >= 30){
				passer[1] = 0; timer2 = 0;
			}
		}
		
		if(isLive){
			//Pop eyes
			if(passer[3] == 1 && notFocused){
				notFocused = false;
				leftPupil.scale(0.8);
				rightPupil.scale(0.8);
				
				setTimeout(function(){ 
					notFocused = true;
					leftPupil.scale(1.25);
					rightPupil.scale(1.25);
					passer[3] = 0; 
				}, 3000);
					 
			}
			//Pop eyes	centroid limit looks wierd for now.			
			/*if(centra){
				leftPupil.scale(0.8);
				rightPupil.scale(0.8);
			}else{
				leftPupil.scale(1.25);
				rightPupil.scale(1.25);
			}*/
			//Pop mouth
			if(isSpeaking){
				mouthOpen.bringToFront();
			}else{
				mouthOpen.sendToBack();
			}
		}else{
			//Pop eyes
			if(passer[3] == 1 && notFocused){
				notFocused = false;
				leftPupil.scale(0.8);
				rightPupil.scale(0.8);
				
				setTimeout(function(){ 
					notFocused = true;
					leftPupil.scale(1.25);
					rightPupil.scale(1.25);
					passer[3] = 0; 
				}, 3000);
					 
			}
			//Pop mouth
			if(passer[2] == 1){
				mouthOpen.bringToFront();
				timer3++;
				if(timer3 >= 30){
					mouthOpen.sendToBack();
					passer[2] = 0; 
					timer3 = 0;
				}
			}
		}
		view.draw();
	}
	</script>
	<script src="volume-meter.js"></script>
	<script src="analyser.js"></script>

	<!-- Include the main app logic -->
	<script src="main.js"></script>
	<script type="text/javascript">
	window.onload = function() {
		onLoadForSVG();
		audio_file.onchange = function(){
			var audioFiles = this.files;
			var audioFile = URL.createObjectURL(audioFiles[0]); 
			audio_player.src = audioFile; 
			audio_player.play();
		};
		onLoadForAudio();
	}
	function onClickSelectAudio(){
		var elem = document.getElementById("toggler");
		isLive = (!isLive);
		if (isLive) elem.value = "Mic is on";
		else elem.value = "Music is On";
		discon(isLive);	
	}
	</script>
</head>
<body>
	<div class="fixeddiv center"><canvas id="canvas" class="center" width="640" height="640" resize></canvas></div>
	<div class="fixeddiv center">
		<audio id="audio_player" class="center" controls src="test2.mp3"></audio>
		<br><br>
		<label>Toggle mic or music: </label>
		<input id="toggler" type="button" onclick="onClickSelectAudio()" value="Music is On"/>
		<br><br>
		<label>Avarage volume (view-only): </label>
		<input type="range" id="averagerms" min="0" max="0.5" step="0.01" />
		<br><br>
		<label>Avarage frequency (view-only): </label>
		<input type="range"id="averagefreq" min="20" max="2000" step="1" />	
		<br><br>
		<label>Sensitivity (modifyable): </label>
		<input type="range"id="sensitivity" min="0" max="1" step="0.05" value="0.5"/>	
		<br><br>
		<!--<label>SVG</label>
		<input type="file" id="file" value="j2nes.svg"/>
		<br><br>-->
		<label>Audio</label>
		<input id="audio_file" type="file" accept="audio/*" />
	</div>
</body>
</html>
