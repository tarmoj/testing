<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Import From File</title>
    <link rel="stylesheet" href="style.css">
    <script type="text/javascript" src="paper-full.js"></script>
	<script type="text/javascript">
	paper.install(window);
	var leftEar, leftEarRot = 0, leftEarPivot, rightEar, rightEarRot = 0, rightEarPivot, 
		leftHand, leftHandRot = 0, leftHandPivot, rightHand, rightHandRot = 0, rightHandPivot, 
		leftLeg, leftLegRot = 0, leftLegPivot, rightLeg, rightLegRot = 0, rightLegPivot,
		leftPupil, rightPupil, mouthOpen, wholeBody, avarageVolume = 0, isLive = 0, passer = [0,0,0,0];
	function onLoadForSVG() {
		//var canvas = document.getElementById('canvas');
		// Create an empty project and a view for the canvas:
		paper.setup('canvas');
		
		var file = document.getElementById('file');
		file.addEventListener('change', function (event) {
		
			var files = event.target.files;
			for (var i = 0; i < files.length; i++) {
				var file = files[i];
				if (file.type.match('svg')) {
					project.clear();
					project.importSVG(file, function(item) {
						wholeBody = item;
						setupSVG();
						view.draw();
						view.onFrame = function(event) {
							//Every frame, rotate the path by 3 degrees:
							//leftEar.rotate(avarageVolume, leftEarPivot);
							react(event);
							view.draw();
						}
					});
				}
			}
		});
	}
	function setupSVG(){
		leftEar = project.getItem( { name: "left-ear" });
		if(project.getItem( { name: "pivot-left-ear" }))
			leftEarPivot = project.getItem( { name: "pivot-left-ear" }).position;
		rightEar = project.getItem( { name: "right-ear" });
		if(project.getItem( { name: "pivot-right-ear" }))
			rightEarPivot = project.getItem( { name: "pivot-right-ear" }).position;
		leftHand = project.getItem( { name: "left-hand" });
		if(project.getItem( { name: "pivot-left-hand" }))
			leftHandPivot = project.getItem( { name: "pivot-left-hand" }).position;
		rightHand = project.getItem( { name: "right-hand" });
		if(project.getItem( { name: "pivot-right-hand" }))
			rightHandPivot = project.getItem( { name: "pivot-right-hand" }).position;
		leftLeg = project.getItem( { name: "left-leg" });
		if(project.getItem( { name: "pivot-left-leg" }))
			leftLegPivot = project.getItem( { name: "pivot-left-leg" }).position;
		rightLeg = project.getItem( { name: "right-leg" });
		if(project.getItem( { name: "pivot-right-leg" }))
			rightLegPivot = project.getItem( { name: "pivot-right-leg" }).position;
		leftPupil = project.getItem( { name: "left-pupil" });
		rightPupil = project.getItem( { name: "right-pupil" });
		mouthOpen = project.getItem( { name: "mouth-open" });
	}
	// t: current time, b: begInnIng value, c: change In value, d: duration
	function easeOutBack(t, b, c, d, s){
		if (s == undefined) 
			s = 1.70158; 
		return c*((t=t/d-1)*t*((s+1)*t + s) + 1) + b; 
	}
	function easeInOutQuart(t, b, c, d) { 
 		if ((t/=d/2) < 1) return c/2*t*t*t*t + b; 
 		return -c/2 * ((t-=2)*t*t*t - 2) + b; 
	}

	var step = 3;
	var enlarged = 0;
	var lastAngle = 0;
	var timer1 = 0, timer2 = 0, timer3 = 0, timer4 = 0;
	function react(event){
		//leftEar.fillColor = new Color(Math.random(), Math.random(), Math.random());
		if(isLive){
			leftEarRot =- (avarageVolume * 70  - 41);
		}else{
			leftEarRot =- (avarageVolume * 250  - 41);
		}
		step = leftEarRot - lastAngle;
		lastAngle = leftEarRot;
		
		//if(leftEarRot >= -21 && leftEarRot <= 21){
		leftEar.rotate(step, leftEarPivot);
		rightEar.rotate(-step, rightEarPivot);
		//leftHand.rotate(step, leftHandPivot);
		//rightHand.rotate(step, rightHandPivot);
		//}
		/*else if(leftEarRot > 21){
			step = -3;
		}else if(leftEarRot < -21){
			step = 3;
		}*/
		
		// A cylic value between -1 and 1
		//if(timer >= 2*Math.PI){

		// Change the y position of the segment point:
		//segment.point.y = sinus + 1.1;
		//wholeBody.sca
		/*if(passer[0] == 1){
			timer++;
			if(timer < 120){
				var val= easeInOutQuart(timer, 1.0, 0.2, 120);
				leftPupil.scale(val);
				rightPupil.scale(val);
			}else if(timer >= 120){
				var val= easeInOutQuart(timer, 1.0, -0.2, 120);
				leftPupil.scale(val);
				rightPupil.scale(val);
			} else if(timer >= 240){
				passer[0] = 0; timer = 0;
			}
		}*/
		//Left handed hello
		if(passer[0] == 1){
			timer1++;
			if(timer1 < 15){
				var val= easeInOutQuart(timer1, 0, 5, 15);
				leftHand.rotate(-val, leftHandPivot);
			}else if(timer1 < 30){
				var val= easeInOutQuart(timer1-15, 0, 5, 15);
				leftHand.rotate(val, leftHandPivot);
			}
			if(timer1 >= 30){
				passer[0] = 0; timer1 = 0;
			}
		}
		//Right handed hello
		if(passer[1] == 1){
			timer2++;
			if(timer2 < 15){
				var val= easeInOutQuart(timer2, 0, 5, 15);
				rightHand.rotate(val, rightHandPivot);
			}else if(timer2 < 30){
				var val= easeInOutQuart(timer2-15, 0, 5, 15);
				rightHand.rotate(-val, rightHandPivot);
			}
			
			if(timer2 >= 30){
				passer[1] = 0; timer2 = 0;
			}
		}
		//Pop mouth
		if(passer[3] == 1){
			mouthOpen.bringToFront();
			timer3++;
			if(timer3 >= 30){
				mouthOpen.sendToBack();
				passer[3] = 0; 
				timer3 = 0;
			}
		}
		/*//Red Eyes
		if(passer[4] == 1){
			leftPupil.fillColor
			rightPupil
			timer4++;
			if(timer4 >= 30){
				mouthOpen.sendToBack();
				passer[3] = 0; 
				timer4 = 0;
			}
		}*/
		view.draw();
	}
	</script>
	<script src="volume-meter.js"></script>
	<!-- Include the main app logic -->
	<script src="main.js"></script>
	<script type="text/javascript">
	window.onload = function() {
		onLoadForSVG();
		audio_file.onchange = function(){
			var audioFiles = this.files;
			var audioFile = URL.createObjectURL(audioFiles[0]); 
			audio_player.src = audioFile; 
			audio_player.play();
		};
		onLoadForAudio();
	}
	</script>
</head>
<body>
	<audio id="audio_player" controls src="test7.mp3"></audio>
	<br>
	<input type="range" id="averagerms" min="0" max="0.5" step="0.01" >Keskmine helitugevus</input><br>
    <br>
    <form>
	<label>SVG</label>
    <input type="file" id="file" value="j2nes1.svg"/>
	<label>Audio</label>
	<input id="audio_file" type="file" accept="audio/*" />
    </form>
    <canvas id="canvas" width="1000" height="1000"></canvas>
</body>
</html>
